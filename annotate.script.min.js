const e = "load",
  t = "click",
  o = "update",
  n = "cursorTypeChange",
  i = "locationChange",
  r = "keydown",
  a = "toggleInbox";
let d = !0,
  c = "browse";
const s = new Image();
s.src =
  "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNSAyNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyLjM3MzcgMjRMMTEuOTc5MiAyNEM1LjkxNTU0IDI0IDEgMTkuMDg0NSAxIDEzLjAyMDhMMSAxTDEyLjYyNjMgMUMxOC45MDc4IDEgMjQgNi4wOTIyIDI0IDEyLjM3MzdDMjQgMTguNzk0NyAxOC43OTQ3IDI0IDEyLjM3MzcgMjRaIiBmaWxsPSIjMjYyNjI2IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KPGxpbmUgeDE9IjEyLjg3NSIgeTE9IjguNSIgeDI9IjEyLjg3NSIgeTI9IjE1LjI1IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8bGluZSB4MT0iOS4xMjUiIHkxPSIxMS41IiB4Mj0iMTUuODc1IiB5Mj0iMTEuNSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+Cg==";
let l = [];
import { finder as u } from "https://medv.io/finder/finder.js";
function g(e, t) {
  window.top.postMessage(JSON.stringify({ type: e, data: t }), "*");
}
function f(e) {
  const t = l.filter((t) => t.route === e);
  setTimeout(() => {
    const o = t.map((e) => {
      const t = document.querySelector(e.parentSelector);
      if (!t)
        return {
          parentSelector: e.parentSelector,
          x: -100,
          y: -100,
          offsetWidth: 0,
          offsetHeight: 0,
          tagName: "",
        };
      const o = t.getBoundingClientRect();
      return {
        parentSelector: e.parentSelector,
        x: o.x,
        y: o.y,
        offsetWidth: t.offsetWidth,
        offsetHeight: t.offsetHeight,
        tagName: t.tagName,
        xPercent: e.xPercent,
        yPercent: e.yPercent,
        route: window.location.pathname,
      };
    });
    g(i, { route: e || window.location.pathname, elementsPosition: o }), I();
  }, 100);
}
var m, y;
function p() {
  if (l && l.length <= 0) return;
  const e = l
    .filter((e) => {
      if (e) return e.route === window.location.pathname;
    })
    .map((e) => {
      const t = document.querySelector(e.parentSelector);
      if (!t)
        return {
          parentSelector: e.parentSelector,
          x: -100,
          y: -100,
          offsetWidth: 0,
          offsetHeight: 0,
          tagName: "",
        };
      const o = t.getBoundingClientRect();
      return {
        parentSelector: e.parentSelector,
        x: o.x,
        y: o.y,
        offsetWidth: o.width,
        offsetHeight: o.height,
        tagName: t.tagName,
      };
    });
  g(o, e);
}
function h() {
  if ("browse" === c) {
    const e = document.getElementById("bounding-box");
    e && document.body.removeChild(e),
      document.body.style.removeProperty("cursor");
    document.querySelectorAll("*").forEach((e) => {
      e.style.removeProperty("cursor");
    });
  } else {
    document.body.style.setProperty(
      "cursor",
      "url('" + s.src + "'), auto",
      "important"
    );
    document.querySelectorAll("*").forEach((e) => {
      e.style.setProperty("cursor", "url('" + s.src + "'), auto", "important");
    });
  }
}
function w(e) {
  const t = e.getBoundingClientRect();
  return { left: t.left + window.scrollX, top: t.top + window.scrollY };
}
(m = window.history),
  (y = m.pushState),
  f(window.location.pathname),
  (m.pushState = function (e) {
    return (
      "function" == typeof m.onpushstate && m.onpushstate({ state: e }),
      setTimeout(function () {
        f(window.location.pathname);
      }, 0),
      y.apply(m, arguments)
    );
  }),
  window.addEventListener("popstate", function () {
    setTimeout(function () {
      f(window.location.pathname);
    }, 0);
  }),
  window.addEventListener("hashchange", function () {
    setTimeout(function () {
      f(window.location.pathname);
    }, 0);
  }),
  window.addEventListener(e, function () {
    g(e, {});
  }),
  document.addEventListener("mousemove", function (e) {
    const t = e.target;
    if ("browse" === c) return;
    if (t.classList.contains("annotation-pin")) return;
    const o = t.getBoundingClientRect();
    let n = document.getElementById("bounding-box");
    n ||
      ((n = document.createElement("div")),
      n.setAttribute("id", "bounding-box"),
      document.body.appendChild(n),
      (n.style.position = "absolute"),
      (n.style.border = "1px dashed gray"),
      (n.style.zIndex = 99999),
      (n.style.pointerEvents = "none")),
      (n.style.top = w(t).top + "px"),
      (n.style.left = w(t).left + "px"),
      (n.style.width = o.width + "px"),
      (n.style.height = o.height + "px");
  }),
  window.addEventListener("message", function (t) {
    const o = JSON.parse(t.data);
    if (o.type === n) (c = o.data.cursorType), h();
    else if (o.type === e) {
      if (!o.data || o.data.length <= 0) return;
      const e = o.data.map((e) => {
        const t = document.querySelector(e.parentSelector);
        return {
          parentSelector: e.parentSelector,
          node: t || null,
          xPercent: e.xPercent,
          yPercent: e.yPercent,
          route: e.route,
          fallbackSelector: e.fallbackSelector,
          x: e.x,
          y: e.y,
          offsetWidth: e.offsetWidth,
          offsetHeight: e.offsetHeight,
          tagName: e.tagName,
        };
      });
      (l = e), I(), p();
    } else if ("add" === o.type) {
      const e = document.querySelector(o.data.parentSelector),
        t = e.getBoundingClientRect(),
        n = {
          parentSelector: o.data.parentSelector,
          node: e,
          xPercent: o.data.xPercent,
          yPercent: o.data.yPercent,
          route: o.data.route,
          fallbackSelector: o.data.fallbackSelector,
          x: t.x,
          y: t.y,
          offsetWidth: e.offsetWidth,
          offsetHeight: e.offsetHeight,
          tagName: e.tagName,
        };
      l.push(n), I();
    }
  }),
  window.addEventListener(
    t,
    function (e) {
      if ("browse" === c) return g(t, { isNew: !1 }), !0;
      e.preventDefault(), e.stopPropagation(), e.stopImmediatePropagation();
      const o = "target" in e ? e.target : e.srcElement,
        n = u(e.target, {
          root: this.document,
          idName: () => !0,
          className: (e) => e.length > 5,
          tagName: () => !1,
          attr: () => !1,
          seedMinLength: 1,
          optimizedMinLength: 2,
          threshold: 1e3,
          maxNumberOfTries: 1e4,
        }),
        i = u(e.target, {
          root: document,
          idName: () => !0,
          tagName: () => !1,
          attr: () => !1,
          seedMinLength: 1,
          optimizedMinLength: 2,
          threshold: 1e3,
          maxNumberOfTries: 1e4,
        }),
        r = o.getBoundingClientRect(),
        a = ((e.clientX - r.left) / r.width) * 100,
        s = ((e.clientY - r.top) / r.height) * 100;
      g(t, {
        isNew: d,
        parentSelector: n,
        fallbackSelector: i,
        xPercent: a,
        yPercent: s,
        route: window.location.pathname,
        x: r.x,
        y: r.y,
        offsetWidth: r.width,
        offsetHeight: r.height,
        tagName: o.tagName,
      }),
        (d = !d);
    },
    !0
  ),
  window.addEventListener(r, function (e) {
    e.shiftKey &&
      "C" === e.key &&
      (g(n, { cursorType: "browse" === c ? "comment" : "browse" }),
      (c = "browse" === c ? "comment" : "browse"),
      h()),
      e.shiftKey && "I" === e.key && g(a, {});
  }),
  window.addEventListener("scroll", function () {
    p();
  }),
  window.addEventListener("resize", p);
const I = () => {
  new MutationObserver((e) => {
    if (
      e.some(
        (e) =>
          "bounding-box" === e.target.id ||
          ("BODY" === e.target.tagName &&
            ("bounding-box" === e.addedNodes[0]?.id ||
              "bounding-box" === e.removedNodes[0]?.id))
      )
    )
      return !1;
    setTimeout(() => {
      p();
    }, 400);
  }).observe(window.document.body, {
    attributes: !0,
    childList: !0,
    subtree: !0,
  });
};
